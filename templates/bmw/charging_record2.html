{% extends 'base.html' %}
{% load staticfiles %}
{% block content %}
            <div class="row wrapper border-bottom white-bg page-heading">
                <div class="col-lg-10">
                    <h2>充电记录统计</h2>
                </div>
            </div>

            <div class="wrapper wrapper-content animated fadeInRight">
                <div class="row">
					 <div class="col-md-12">
						<div class="ibox float-e-margins">
							<div class="ibox-title">
								<h5>充电记录</h5>
								<div class="ibox-tools">
									<select id="select-group" style="margin-right: 15px;width: 120px;background-color: #fff;border-radius: 5px;" onchange="ui.select_change()"></select>
									<select id="select-date"  style="margin-right: 15px;width: 120px;background-color: #fff;border-radius: 5px;" onchange="ui.select_change()">
										<option value="14">近30天</option>
										<option value="15">近6个月</option>
										<option value="16">近12个月</option>
									</select>
									<a class="collapse-link">
										<i class="fa fa-chevron-up"></i>
									</a>
									<a class="close-link">
										<i class="fa fa-times"></i>
									</a>
								</div>
							</div>
							<div class="ibox-content" style="height: 900px">
								<div class="flot-chart">
									<div class="flot-chart-content" id="scatter_charts" style="height: 850px"></div>
								</div>
							</div>
						</div>
					</div>
                </div>
            </div>
{% endblock content %}


{% block script %}
<script>
		var scatterChart = echarts.init(document.getElementById("scatter_charts"));
		var ui = {
			scatterChartDraw: function(){
				var _this = this;
				option = {
					backgroundColor: '#404a59',	//404a59
					//color: [
					//	'#dd4444', '#fec42c', '#80F1BE'
					//],
					legend: {
						y: 'top',
						data: [],
						textStyle: {
							color: '#fff',
							fontSize: 16
						}
					},
					grid: {
						x: '10%',
						x2: 150,
						y: '18%',
						y2: '10%'
					},
					tooltip: {
						padding: 10,
						backgroundColor: '#222',
						borderColor: '#777',
						borderWidth: 1,
						formatter: function (obj) {
							var value = obj.value;
							return '<div style="border-bottom: 1px solid rgba(255,255,255,.3); font-size: 18px;padding-bottom: 7px;margin-bottom: 7px">'
								+ obj.seriesName + ' ' + value[0] + '日：'
								+ '卡号: ' + value[7]
								+ '</div>'
								+ '充电电量: ' + value[1] + '<br>'
								+ '充电时长: ' + value[2] + '<br>'
								+ '充电电压: ' + value[3] + '<br>'
								+ '充电相位: ' + value[4] + '<br>'
								+ '充电电流: ' + value[5] + '<br>'
								+ '故障: ' + value[6] + '<br>';
						}
					},
					xAxis:{
							type: 'category',
							name: '日期',
							nameTextStyle: {
								color: '#fff',
								fontSize: 14
							},
							axisLabel:{
							  interval:0,  //类目全显
							  rotate:-30
							},
							axisTick: {
								alignWithLabel: true
							},
							axisLine: {
								onZero: false,
								lineStyle: {
									color: '#eee'
								}
							},
					},
					yAxis: {
						type: 'value',
						name: '充电电量',
						nameLocation: 'end',
						nameGap: 20,
						nameTextStyle: {
							color: '#fff',
							fontSize: 16
						},
						axisLine: {
							lineStyle: {
								color: '#eee'
							}
						},
						splitLine: {
							show: false
						}
					},
					visualMap: [
						{
							left: 'right',
							top: '10%',
							dimension: 1,
							min: 0,
							max: 600,
							itemWidth: 30,
							itemHeight: 120,
							calculable: true,
							precision: 0.1,
							text: ['圆形大小：充电时长'],
							textGap: 30,
							textStyle: {
								color: '#fff'
							},
							inRange: {
								symbolSize: [10, 70]
							},
							outOfRange: {
								symbolSize: [10, 70],
								color: ['rgba(255,255,255,.2)']
							},
							controller: {
								inRange: {
									color: ['#c23531']
								},
								outOfRange: {
									color: ['#444']
								}
							}
						},
						{
							left: 'right',
							bottom: '5%',
							//dimension: 6,
							min: 0,
							max: 100,
							itemHeight: 120,
							calculable: true,
							precision: 0.1,
							text: ['明暗：故障记录'],
							textGap: 30,
							textStyle: {
								color: '#fff'
							},
							inRange: {
								colorLightness: [1, 0.5]
							},
							outOfRange: {
								color: ['rgba(255,255,255,.2)']
							},
							controller: {
								inRange: {
									color: ['#c23531']
								},
								outOfRange: {
									color: ['#444']
								}
							}
						}
					],
					series: []
				};
				return option;
			},
			updatescatterChart: function() {
				var _this = this;
				var option = _this.scatterChartDraw();
				var group_id = $("#select-group").val();
				var mode = $("#select-date").val();
				scatterChart.showLoading();
				$.ajax({
					url: '/bmw/chart/getChargingRecordScatter',
					method: 'get',
					data: {group_id: group_id,mode: mode},
					timeout: 5000,
					success: function(res){
						scatterChart.hideLoading();
						for(var i=0;i<res.charger_list.length;i++)
						{
							option.legend.data.push(res.charger_list[i].charger_id);

							var item = {
								name: res.charger_list[i].charger_id,
								type: 'scatter',
								itemStyle: {
									normal: {
										opacity: 0.8,
										shadowBlur: 10,
										shadowOffsetX: 0,
										shadowOffsetY: 0,
										shadowColor: 'rgba(0, 0, 0, 0.5)'
									}
								},
								data: res.charger_list[i].y
							}
							option.series.push(item);
						}
						
						option.xAxis.data = res.date_list;
						scatterChart.setOption(option);
					},
					error: function(){
						console.log('connect /bmw/chart/getChargingRecordScatter failed');
					}
				});
			},
			getGroupList: function(){
				var groupList = null;
				$.ajax({
					url: '/api/charger/groups/',
					method: 'get',
					async : false,
					success: function(data){
						groupList = data;
					},
					error: function(e){
						console.log('connect /api/charger/groups/ error');
					}
				});
				return groupList;
			},
			initscatterSelect: function(){
				var group_list = ui.getGroupList();
				if(group_list){
					group_list.forEach(function (gid) {
						ui.addSelectOption($('#select-group'), gid["vchgroupid"]);
					});
				}
			},
			addSelectOption: function(obj, val){
				var option = document.createElement("option");
				$(option).val(val);
				$(option).text(val);
				obj.append(option);
			},
			select_change: function(){
				var _this = this;
				this.updatescatterChart();
			},
			init: function(){
				this.initscatterSelect();
				this.updatescatterChart();
			}
		}
		$(document).ready(function(){
			ui.init();
		});
</script>
{% endblock script %}
