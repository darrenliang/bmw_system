{% extends 'base.html' %}
{% load staticfiles %}

{% block header %}
    <!-- 本页独有插件 时间插件-->
    <link href="{% static 'css/plugins/datapicker/datepicker3.css' %}" rel="stylesheet">
    <style>
        .ibox-title{ border-width: 3px 1px; }
        .ibox-content{ border: 1px solid #e7eaec; }
        .widget.style1 h2{ font-size: 16px; }
        .buttons .widget{ overflow: hidden; }
        .buttons .widget > div{ float: left; }
        .buttons .widget > div:first-child{ margin-right: 10px; }
    </style>
{% endblock %}
{% block content %}
        <div class="row wrapper border-bottom white-bg page-heading">
            <div class="col-lg-10">
                <h2>75001234  详细信息</h2>
            </div>
            <div class="col-lg-2">

            </div>
        </div>

        <div class="wrapper wrapper-content animated fadeInRight">

            <div class="row">
                <div class="col-lg-12">
                    <div class="ibox product-detail">
                        <div class="ibox-content">
                            <!-- 按钮1 -->
                            <div class="buttons">
                                <ul class="list-inline">
                                    <li>
                                        <div class="widget style1 navy-bg">
                                            <div>
                                                <i class="fa fa-calendar fa-2x"></i>
                                            </div>
                                            <div class="text-right">
                                                <h2 class="font-bold">查看充电日志</h2>
                                            </div>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="widget style1 navy-bg">
                                            <div>
                                                <i class="fa fa-building-o fa-2x"></i>
                                            </div>
                                            <div class="text-right">
                                                <h2 class="font-bold">查看充电记录</h2>
                                            </div>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="widget style1 lazur-bg">
                                            <div>
                                                <i class="fa fa-play fa-2x"></i>
                                            </div>
                                            <div class="text-right">
                                                <h2 class="font-bold">开始充电</h2>
                                            </div>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="widget style1 lazur-bg">
                                            <div>
                                                <i class="fa fa-stop fa-2x"></i>
                                            </div>
                                            <div class="text-right">
                                                <h2 class="font-bold">停止充电</h2>
                                            </div>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="widget style1 navy-bg">
                                            <div>
                                                <i class="fa fa-repeat fa-2x"></i>
                                            </div>
                                            <div class="text-right">
                                                <h2 class="font-bold">更新</h2>
                                            </div>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="widget style1 navy-bg">
                                            <div>
                                                <i class="fa fa-undo fa-2x"></i>
                                            </div>
                                            <div class="text-right">
                                                <h2 class="font-bold">复位</h2>
                                            </div>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="widget style1 navy-bg">
                                            <div>
                                                <i class="fa fa-history fa-2x"></i>
                                            </div>
                                            <div class="text-right">
                                                <h2 class="font-bold">拓展</h2>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                            </div>

                            <div class="row">
                                <div class="col-md-5">
                                    <div class="ibox">
                                        <div class="ibox-title">
                                            <h5>Charger Information </h5>
                                        </div>
                                        <div class="ibox-content no-padding">
                                            <table id="chargerInfoData" class="table table-hover margin bottom">
                                                <!-- <tbody>
                                                    <tr>
                                                        <td colspan="2" class="font-bold">Charger Detail</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Charger Model</td>
                                                        <td id="vchModelId">N/A</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Charger Vender</td>
                                                        <td id="vchvenderid">N/A</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Serial Number</td>
                                                        <td id="vchSerialNo">N/A</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Firmware Version</td>
                                                        <td id="vchFirmwareVer">N/A</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Total Consumed Power</td>
                                                        <td id="dblAccumlatedPower">N/A</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Total charging time</td>
                                                        <td id="dblAccumlatedMinute">N/A</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Charger IP</td>
                                                        <td id="vchIP">N/A</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Mac</td>
                                                        <td id="vchMac">N/A</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Cable Plugged</td>
                                                        <td id="vchSoket">N/A</td>
                                                    </tr>
                                                    <tr>
                                                        <td>charger Status</td>
                                                        <td id="vchstate">N/A</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Feedback current</td>
                                                        <td id="intcurrentfeedback">N/A</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Int current</td>
                                                        <td id="intcurrent">N/A</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Supply current</td>
                                                        <td id="intchargingcurrent">N/A</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Consuming energy</td>
                                                        <td id="intconsumedenergy">N/A</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Elapsedtime</td>
                                                        <td id="intElapsedTime">N/A</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Phase charging</td>
                                                        <td id="intchargingphase">N/A</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Command</td>
                                                        <td id="vchcommand">N/A</td>
                                                    </tr>
                                                    <tr>
                                                        <td>MaxCurrent support</td>
                                                        <td id="dblmaxcurrent">N/A</td>
                                                    </tr>
                                                    <tr>
                                                        <td>minCurrent support</td>
                                                        <td id="dblmincurrent">N/A</td>
                                                    </tr>
                                                    <tr>
                                                        <td>Max line support</td>
                                                        <td id="intMaxPhase">N/A</td>
                                                    </tr>

                                                </tbody> -->
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-7">
                                    <div class="ibox float-e-margins">
                                        <div class="ibox-title">
                                            <h5>Live Chart Example</h5>
                                        </div>
                                        <div class="ibox-content">
                                            <div class="flot-chart">
                                                <div class="flot-chart-content" id="flot-line-chart-moving"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="ibox m-t">
                                        <div class="ibox-title">
                                            <h5>Charger Record</h5>
                                        </div>
                                        <div class="ibox-content no-padding">
                                            <div class="form-horizontal m-t">
                                                <div class="form-group" id="data_2">
                                                    <label class="col-lg-4 control-label">Date</label>
                                                    <div class="col-lg-7">
                                                        <div class="input-group date">
                                                            <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                                                            <input type="text" class="form-control" value="2015-11-24">
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label class="col-lg-4 control-label">Record ID</label>
                                                    <div class="col-lg-7">
                                                        <select name="recordIdList" class="form-control" id="recordIdList">
                                                            <option value="0">请选择</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label class="col-lg-4 control-label">Charging Code</label>
                                                    <div class="col-lg-7">
                                                        <input type="text" class="form-control" id="chargingCode">
                                                    </div>
                                                </div>

                                                <button id="start_btn" class="btn btn-primary btn-sm btn-block" data-toggle="modal" data-target="#data_2_modal">Start</button>

                                                 <div class="modal inmodal" id="data_2_modal" tabindex="-1" role="dialog" aria-hidden="true">
                                                    <div class="modal-dialog">
                                                        <div class="modal-content animated bounceInRight">
                                                            <div class="modal-header">
                                                                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                                                                <h4 class="modal-title">Info</h4>
                                                            </div>
                                                            <div class="modal-body">
                                                                <div class="ibox">
                                                                    <div class="ibox-content no-padding">
                                                                        <table class="table table-hover margin bottom">
                                                                            <tbody id="modal_info">

                                                                            </tbody>
                                                                        </table>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

{% endblock content %}

{% block script %}

<!-- slick carousel-->
<script src="{% static 'js/plugins/slick/slick.min.js' %}"></script>

<!-- 本页独有插件 -->
<!-- Flot -->
<script src="{% static 'js/plugins/flot/jquery.flot.js' %}"></script>
<script src="{% static 'js/plugins/flot/jquery.flot.tooltip.min.js' %}"></script>
<script src="{% static 'js/plugins/flot/jquery.flot.resize.js' %}"></script>
<script src="{% static 'js/plugins/flot/jquery.flot.pie.js' %}"></script>
<script src="{% static 'js/plugins/flot/jquery.flot.time.js' %}"></script>

<!-- Date picker -->
<script src="{% static 'js/plugins/datapicker/bootstrap-datepicker.js' %}"></script>

    <!-- Mainly scripts -->
    <script src="{% static 'js/mqttws31.js' %}"></script>
    <script type="text/javascript">
    $(document).ready(function(){
        //Using the HiveMQ public Broker, with a random client Id
        var client = new Messaging.Client("mqtt.e-chong.com", 8083, "test", 10);

        //Gets  called if the websocket/mqtt connection gets disconnected for any reason
        client.onConnectionLost = function(responseObject) {
            //Depending on your scenario you could implement a reconnect logic here
            alert("connection lost: " + responseObject.errorMessage);
        };
        var vol_data = [];
        var vol = [];
        //Gets called whenever you receive a message for your subscriptions
        client.onMessageArrived = function(message) {
            var str = message.payloadString;
            try {
                console.log(str);
                if(str){
                    var obj = JSON.parse(str);
                    if(obj.length > 3 && obj[2] == "MeterValues"){
                        supplyCurrent = obj[3]["MeterValue"]["SupplyCurrent"];
                        consumedEnergy = obj[3]["MeterValue"]["ConsumedEnergy"];
                        console.log("supplyCurrent="+supplyCurrent+", consumedEnergy="+consumedEnergy);
                        //draw
                        drawPlot(supplyCurrent, consumedEnergy)
                    }
                }
            } catch(e) {
                console.log(e);
            }
        };

        //Connect Options
        var options = {
            timeout: 3,
            //Gets Called if the connection has sucessfully been established
            onSuccess: function() {
                client.subscribe('10245006', {qos: 2});
                //alert("Connected");
            },
            //Gets Called if the connection could not be established
            onFailure: function(message) {
                alert("Connection failed: " + message.errorMessage);
            }
        };

        //Creates a new Messaging.Message Object and sends it to the HiveMQ MQTT Broker
        var publish = function(payload, topic, qos) {
            //Send your message (also possible to serialize it as JSON or protobuf or just use a string, no limitations)
            var message = new Messaging.Message(payload);
            message.destinationName = topic;
            message.qos = qos;
            client.send(message);
        }

        client.connect(options);

        //draw plot with data
        var timeTick = 3;
        var timeCount = 0;//count the time of drawing. 3, 6, 9, 12...
        function drawPlot(supplyCurrent, consumedEnergy){
            supplyCurrent = parseInt(supplyCurrent);
            consumedEnergy = parseInt(consumedEnergy);
            console.log(series[0].data, series[1].data);
            var yGroup = [supplyCurrent, consumedEnergy];
            //draw plot
            if(series && plot){
                timeCount++;
                for(var i=0; i<series.length; i++){
                    if(series[i].data.length > 9){
                        series[i].data.shift();
                    }
                    // +yGroup[i]*Math.sin(Math.random())
                    series[i].data.push([timeCount * timeTick, yGroup[i]]);
                }

                plot.setData(series);
                console.log(series[0].data[0][0])
                plot.getAxes().xaxis.options.min = series[0].data[0][0];
                //plot.getAxes().yaxis.options.max = supplyCurrent>consumedEnergy?supplyCurrent:consumedEnergy;
                plot.setupGrid();
                plot.draw();
            }
        }

        //时间插件
        $('#data_2 .date').datepicker({
            todayBtn: "linked",
            keyboardNavigation: false,
            forceParse: false,
            autoclose: true,
            format: "yyyy-mm-dd",
        }).on('changeDate', function(e) {
            var c_date = e.format();

            $.ajax({
                url: '/api/charging/record/details',
                method: 'get',
                timeout: 3000,
                data: { date: c_date },
                success: function(data){
                    var recordDateResults = data.result;
                    if(recordDateResults.length > 0){
                        $.each(recordDateResults, function(index, item){
                            var $html = $('<option value="'+item.intrecordid+'">'+item.intrecordid+'</option>');
                            $html.data('record',  {
                                "intrecordid": item.intrecordid,
                                "intchargingcode": item.intchargingcode,
                                "vchchargerid": item.vchchargerid,
                                "dttstartqueue": item.dttstartqueue,
                                "dttstarttime": item.dttstarttime,
                                "dttfinishtime": item.dttfinishtime,
                                "dttrealfinish": item.dttrealfinish
                            });
                            $('#recordIdList').append($html);
                        });
                    }
                },
                error: function(){
                    console.log('connect charger details failed');
                }
            });
        });;

        //charger record - charging code
        $('#recordIdList').on('change', function(){
            $('#chargingCode').val($(this).children('option:selected').data('record').intchargingcode);
        });

        $('#start_btn').click(function(){
            var html = '<tr>';
            var result = $('#recordIdList').children('option:selected').data('record');

            for(var r in result){
                html += '<td>'+r+'</td><td>'+result[r]+'</td></tr><tr>';
            }
            html += '</tr>';
            $('#modal_info').html(html);
        });


        //chart
        ///////////////////////////////////////////////////////////////
        //////////https://github.com/flot/flot/blob/master/API.md
        //////////////////////////////////////////////////////////////
        var container = $("#flot-line-chart-moving");

        // Determine how many data points to keep based on the placeholder's initial size;
        // this gives us a nice high-res plot while avoiding more than one point per pixel.

        var maximum = container.outerWidth() / 2 || 300;

        //js draw fake data
        function getRandomData() {
            var data = [];
            var differ = 100;

            if (data.length) {
                data = data.slice(1);
            }

            while (data.length < maximum) {
                var previous = data.length ? data[data.length - 1] : 50;
                var y = previous + Math.random() * 10 - 5;
                //console.log(y)
                data.push(y < 0 ? 0 : y > 100 ? 100 : y);
            }

            // zip the generated y values with the x values

            var res = [];
            for (var i = 0; i < data.length; ++i) {
                res.push([i, data[i]])
            }

            return res;
        }

        var series = [{
            label: 'y=supplyCurrent',
            data: [],
            lines: {
                fill: false
            }
        },{
            label: 'y=consumedEnergy',
            data: [],
            lines: {
                fill: false
            }
        }];


        var plot = $.plot(container, series, {
            grid: {
                color: "#999999",
                tickColor: "#D4D4D4",
                borderWidth:0,
                minBorderMargin: 20,
                labelMargin: 10,
                backgroundColor: {
                    colors: ["#ffffff", "#ffffff"]
                },
                margin: {
                    top: 8,
                    bottom: 20,
                    left: 20
                }
            },
            colors: ["#1ab394",'red'],
            xaxis: {
                min: 0,
                tickFormatter: function(val, axis) {
                    return (val* 10 * 3).toFixed(0);
                }
            },
            yaxis: {
                min: 0,
                max: 100
            },
            legend: {
                show: true
            }
        });

        // Update the random dataset at 25FPS for a smoothly-animating chart

        // setInterval(function updateRandom() {
        //     // series[0].data = getRandomData();
        //     // plot.setData(series);
        //     // plot.draw();
        //     drawPlot(32, 10);
        // }, 2000);


        /*
        ** read from interfaces
        **
        */
        function show(value){
            if(value && value!=='null' && value!=="undefined"){
                return value;
            }else{
                return '暂无数据';
            }
        }


        $.ajax({
            url: '/api/charger/details/',
            method: 'get',
            timeout: 5000,
            data: { },
            success: function(data){
                var result = data.result;
                var html = '<tbody>\
                                <tr>\
                                    <td colspan="2" class="font-bold">Charger Detail</td>\
                                </tr>\
                                <tr>\
                                    <td>Charger Model（电桩硬件型号）</td>\
                                    <td id="vchModelId">'+result.vchModelID+'</td>\
                                </tr>\
                                <tr>\
                                    <td>Charger Vender（电桩供应商）</td>\
                                    <td id="vchvenderid">'+result.vchvenderid+'</td>\
                                </tr>\
                                <tr>\
                                    <td>Serial Number（序列号）</td>\
                                    <td id="vchSerialNo">'+result.vchSerialNo+'</td>\
                                </tr>\
                                <tr>\
                                    <td>Firmware Version（固件版本）</td>\
                                    <td id="vchFirmwareVer">'+result.vchFirmwareVer+'</td>\
                                </tr>\
                                <tr>\
                                    <td>Total Consumed Power（该电桩总共充电量）</td>\
                                    <td id="dblAccumlatedPower">'+result.dblAccumlatedPower+'</td>\
                                </tr>\
                                <tr>\
                                    <td>Total charging time（该电桩总充电时间）</td>\
                                    <td id="dblAccumlatedMinute">'+result.dblAccumlatedMinute+'</td>\
                                </tr>\
                                <tr>\
                                    <td>Charger IP（电桩在系统中的IP地址）</td>\
                                    <td id="vchIP">'+show(result.vchIP)+'</td>\
                                </tr>\
                                <tr>\
                                    <td>Mac（电桩MAC地址）</td>\
                                    <td id="vchMac">'+result.vchMac+'</td>\
                                </tr>\
                                <tr>\
                                    <td>Cable Plugged（电桩枪口型号）</td>\
                                    <td id="vchSoket">'+result.vchSoket+'</td>\
                                </tr>\
                                <tr>\
                                    <td>charger Status（电桩当前状态）</td>\
                                    <td id="vchstate">'+result.vchstate+'</td>\
                                </tr>\
                                <tr>\
                                    <td>Feedback current（电桩实时反馈电流）</td>\
                                    <td id="intcurrentfeedback">'+result.intcurrentfeedback+'</td>\
                                </tr>\
                                <tr>\
                                    <td>Int current（电桩电流）</td>\
                                    <td id="intcurrent">'+result.intcurrent+'</td>\
                                </tr>\
                                <tr>\
                                    <td>Supply current（当前系统分配充电电流）</td>\
                                    <td id="intchargingcurrent">'+result.intchargingcurrent+'</td>\
                                </tr>\
                                <tr>\
                                    <td>Consuming energy（已充电量）</td>\
                                    <td id="intconsumedenergy">'+result.intconsumedenergy+'</td>\
                                </tr>\
                                <tr>\
                                    <td>Elapsedtime（已充时间）</td>\
                                    <td id="intElapsedTime">'+result.intElapsedTime+'</td>\
                                </tr>\
                                <tr>\
                                    <td>Phase charging（充电所在相位）</td>\
                                    <td id="intchargingphase">'+result.intchargingphase+'</td>\
                                </tr>\
                                <tr>\
                                    <td>Command（命令）</td>\
                                    <td id="vchcommand">'+result.vchcommand+'</td>\
                                </tr>\
                                <tr>\
                                    <td>MaxCurrent support（最大支持充电电流）</td>\
                                    <td id="dblmaxcurrent">'+result.dblmaxcurrent+'</td>\
                                </tr>\
                                <tr>\
                                    <td>inCurrent support（最小支持充电电流）</td>\
                                    <td id="dblmincurrent">'+result.dblmincurrent+'</td>\
                                </tr>\
                                <tr>\
                                    <td>Max line support（支持的最大同时充电相位数）</td>\
                                    <td id="intMaxPhase">'+result.intMaxPhase+'</td>\
                                </tr>\
                            </tbody>';
                $('#chargerInfoData').html(html);
            },
            error: function(){
                console.log('connect charger details failed');
            }
        });



    });

</script>

{% endblock script %}


